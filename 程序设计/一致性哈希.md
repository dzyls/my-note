## 一致性哈希

讲一致性哈希前，先回忆一下哈希算法。

### 哈希算法的缺点

哈希算法的作用是把，任意长度的输入通过散列算法，变换出等长的摘要。该输出就是散列值。本质上是对消息就行不可逆的压缩摘要，不同内容可能会有相同的散列值，这种叫哈希碰撞。



在分布式服务中，哈希算法可以用来做负载均衡算法，将相同的参数分散到相同的机器上。

在搭建缓存服务器，也会通过哈希算法将不同的缓存分散到不同服务器，这样访问时通过对key进行哈希就可以得到在哪台服务器上。

举例 ：

搭建一个文件缓存服务集群，共有三台，哈希函数是对文件名进行哈希，那么哈希函数就是 ：

`fileName.hashCode()%3`

这样能快速的访问到文件的缓存服务器，不需要对三台服务器进行遍历。



**但是这会有一个致命的问题 ：**

如果某一台三台缓存服务器的容量不够了，需要加一台服务器，总机器数就变成4台了，那么哈希函数就变成了 ：

`fileName.hashCode()%4`

由于哈希函数改变了，那么所有的缓存都无法访问，都失效了。

如果访问量特别大的话，那么就是缓存雪崩，所有的压力穿过缓存服务器。



也就是说，普通的哈希算法是无法解决 **平滑扩容**的问题的。



而一致性哈希就是这个问题的解决办法。



### 一致性哈希

---

一致性哈希算法是对哈希算法的改进，哈希算法是对机器数进行取模，而一致性哈希算法则是对一个固定数值2^32 进行取模。

这个数字很大，可是我们没有这么多机器怎么办？总不能QPS 5 部署2 ^32台机器吧？

一致性哈希算法对2 ^ 32进行取模，那么取模后的值是在0 - 2^32 -1之间。每一个值就代表一个可以放置缓存节点的位置。但我们没有那么多的机器怎么办？



如果取模后的值没有节点，那么就从这个值向后找。

比如说，对某一个值进行取模后得到值是5，5这个地方是没有缓存节点的，那么就向后找，找到9这个位置上是有一个缓存节点，那么缓存就应该放在9这个节点的。



##### 一致性哈希的优点

---

一致性哈希可以解决普通哈希算法无法平滑扩容的问题。

举个例子，0-2 ^32为哈希环，其中3和9位置上有缓存节点。这个时候加上一个节点6，那也只是3-6之间的缓存失效，不会找到9节点，而是会去找6节点。这样就解决了普通哈希算法增加一个节点或删除一个节点导致所有的缓存都失效的问题。





##### 一致性哈希的缺点

---

一致性哈希也有一个问题，就是数据倾斜。

**数据倾斜**

因为一致性哈希算法是一个哈希环嘛，那么在环中增加一个节点可能会成某些服务器的压力不一样。



