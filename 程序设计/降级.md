# 降级

降级，是确保在大流量时，牺牲次要功能，确保主要功能的正常运行。





### 降级前的准备

---

在决定做降级前，先分析清楚，哪些业务是次要的可以牺牲的，哪些业务是主要的。比如一个购物网站，最重要的是下单、支付。



## 自动降级

自动降级是根据系统、资源情况，来进行降级。



### 超时降级

---

一些远程服务调用，可以设置当远程服务超过某个时间没有返回，则返回默认的数据。比如，推荐系统、评论区。



### 根据失败次数降级

---

当失败次数达到阈值，则对服务进行降级。

然后异步探测服务是否恢复。



### 故障降级

---

如网络故障、DNS故障这种，可以直接降级，返回错误或者默认数据、兜底数据。



### 限流降级

---

抢购或者秒杀一些商品时，常常用到限流降级，当流量超过阈值，此时再去执行也是无意义的，直接返回没抢到是最好的。



## 读服务降级

页面平时在渲染时，可能是动态个性化生成的，是耗费资源的。

如果在大流量的情况下，可以返回CDN的静态页面，这样系统的压力就少了许多。



## 写服务降级

写服务大多数时是不可降级的，但可以转换一下思路。

比如正常的情况下，下单后是要扣减库存，先操作数据库在操作内存。

在降级的情况下，可以直接操作内存，然后投递一条扣减库存的消息。

## 动态配置



在降级时，无论是手动降级还是自动降级，都尽量避免重启。因此要实现动态的配置降级配置。

**自定义监控配置文件服务**

自定义一个线程，监控某个配置文件，当检测到配置文件有更改时，修改Context中的配置。

注意，自定义服务，切记要在JVM关闭前关闭线程。

但是这样有一个缺陷，实际生产中，有N多个应用，需要这样一个一个改，属实太慢了。



**使用第三方**

关于动态配置这块，开源方案还是挺多的。

比如Zookeeper、Consul、Etcd、Nacos。



这样可以统一的配置，就很方便了。

## Hystrix

Hystrix支持熔断、降级，并且支持采样统计。