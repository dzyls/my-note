## 复制

存储高可用的方案，都是通过复制来实现的。如何复制、故障转移、复制延迟等问题是高可用解决方案需要思考的。

**高可用不包括一致性**，如Redis哨兵模式是高可用的，但是主从切换时可能会丢数据。

**高可用不同于鲁棒性**，鲁棒性指的是系统的健壮性【耐操】，应对的是参数错误、磁盘故障、网络过载等情况下系统能否不崩溃；而高可用性是针对于集群而言，集群中某个节点挂掉，不影响整个集群的运作。



### 主备复制

---

主备复制 ：主节点用于读写，并将数据复制到备用节点。

备用节点只是用于备用，如果主节点正常运作，那么备用节点就只是复制数据。如果主机故障，那么系统则不可用；需要人工将备份节点升级为主机。

**优点** ：简单。

**缺点** ：

- 备用节点只是用来备份，浪费机器性能
- 主节点故障时，需要人工操作才能故障转移，这个期间系统是不可用的，比较麻烦。
- 主备复制有延迟，如果延迟比较大，那么可能会丢数据。



适用于 ：各种管理系统，很少对数据做改动。



### 主从复制

---

主从复制 ：主节点用来写或者读，从节点用来读，主节点将数据复制到从节点。

如果主节点宕机，那么系统无法进行写操作，但是可以进行读操作。如果搭配主从切换，则切换更简单。

主从复制存在延迟，可能会出现不一致的情况，如刚发布一个状态就去从库读，可能读不到。应对方法是，

- 写后立刻读，去主库去读。
- 对复制延迟监控，如果延迟大于某个阈值，则提醒人工干预。



**优点** ：充分利用了从节点的性能，避免闲置。

**缺点** ：

- 主从切换需要人工干预



适用于 ：论坛这种情景，写少读多的情况。



### 主主复制

---

都是主节点，互相将自己的数据复制给对方，不用考虑主从切换的事情。客户端轮询去访问就可以了，一个不行就换一个。

主主复制看上去比较简单，但是也要很多缺点 ：

- 数据需要双向复制，互为主从。当有两个主节点还比较好理解，但如果是三个以上的节点呢？每个节点都需要把自己的数据复制给其他节点，这也是一种性能损耗。
- ID怎么设置？如果是自增的，那么可能会出现两个节点同时插入，产生的ID是相同的，因此会冲突。可能要使用雪花ID来避免。但是这样又增加了系统复杂度



## 复制的架构

复制的方式有多种，复制的架构也有不同种类。



### 互联式

---

主从连接，加一个状态通道，用于双方感知状态。

![image-20210909102351740](高可用存储解决方案.assets/image-20210909102351740.png)

状态的感知，可以是一个网络连接，也可以是个接口【如F5调用HTTP探测进程是否存活】，也可以是发送命令【如哨兵模式会定时向Master节点发送INFO命令探测状态】



缺点也很明显：

- 如果只是网络波动导致状态传递暂时不可用，那么双方可能会产生误判。如，备机无法感知到主机的状态，是切换为主机还是不切换呢？如果切换，网络恢复，就会有两个主机，产生脑裂的现象。



### 中介式

---

使用一个中介来探测双方的状态【如哨兵模式】

![image-20210909103149969](高可用存储解决方案.assets/image-20210909103149969.png)

中介式比较简单，使用一个中介去感知双方的状态。

这种应用很多，比如哨兵、zookeeper。

使用中介式架构，有以下优点：

- 状态维护比较简单
- 可以避免脑裂的情况，比如由于网络波动导致主机无法连接到zookeeper，zookeeper告知备机升级为主机，当原主机恢复网络连接时，变为备机的身份。而且zookeeper使用ZAB协议，当集群中不可用服务过半时，服务将不可用，以此避免了脑裂。

> Redis哨兵模式也是中介式，但哨兵模式避免脑裂的做法是通过配置 ：
>
> - min-slaves-to-write ：当与主机连接的备机数目小于这个数字时，主机将拒绝写，读仍然可用
> - min-slaves-max-lag ：当主从复制的延迟大于这个数字，主机也会拒绝写
>
> 由此来尽量保证数据不丢失、集群不脑裂。



但缺点也很明显 ：

- 需要维护一个中介的集群，中介也要保证高可用【zookeeper集群、哨兵集群】，成本高



 ### 模拟式

---

备机模拟为一个客户端，定时去访问主机。这种类似于互联式，但又有不同，模拟式是单向访问，互联式是双向的。

![image-20210909104439374](高可用存储解决方案.assets/image-20210909104439374.png)

缺点和互联式一样，很明显 ：

- 当网络临时波动，会造成备机误判，错误的升为主机，导致**脑裂**



## 数据集群架构

数据集群架构的也有不同，